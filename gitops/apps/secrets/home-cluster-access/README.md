# Cluster Kubeconfig Access

This application generates a kubeconfig file that allows you to access your Kubernetes cluster via `kubectl`.

## How It Works

A PreSync hook job runs before ArgoCD syncs this application. The job:
1. Finds the ArgoCD cluster secret containing the kubeconfig
2. Extracts the kubeconfig
3. Creates two resources in the `secrets` namespace:
   - **Secret**: `cluster-kubeconfig` - Contains the kubeconfig file (ready to download)
   - **ConfigMap**: `cluster-kubeconfig-view` - Contains base64-encoded kubeconfig (easier to view/copy)

These resources are managed by ArgoCD (defined in Git) so they appear in the `secrets-stack` application.

Both resources are labeled with `purpose=cluster-access` for easy filtering in the ArgoCD UI.

## Accessing Your Kubeconfig

### Via ArgoCD UI:

1. **Navigate to Resources**:
   - Go to your ArgoCD UI
   - Click on "Applications" → Select "home-cluster-access" or "secrets-stack"
   - Click on the "Resources" tab
   - Filter by label: `purpose=cluster-access`

2. **Download the Secret**:
   - Find the secret `cluster-kubeconfig` in the `secrets` namespace
   - Click on it to view details
   - Download the `kubeconfig` key value
   - Save it as `~/.kube/config` or use with: `kubectl --kubeconfig=./kubeconfig get nodes`

3. **Or View the ConfigMap**:
   - Find the configmap `cluster-kubeconfig-view` in the `secrets` namespace
   - Copy the `kubeconfig.b64` value
   - Decode it: `echo '<base64-value>' | base64 -d > kubeconfig`

### Direct Access (if you have kubectl access):

```bash
# Get the kubeconfig from secret
kubectl -n secrets get secret cluster-kubeconfig -o jsonpath='{.data.kubeconfig}' | base64 -d > ~/.kube/config

# Or get from configmap
kubectl -n secrets get configmap cluster-kubeconfig-view -o jsonpath='{.data.kubeconfig\.b64}' | base64 -d > ~/.kube/config
```

## Troubleshooting

### Job Fails to Find Cluster Secret
- Verify ArgoCD has a cluster secret: Check ArgoCD UI → Settings → Clusters
- The job looks for secrets with label `argocd.argoproj.io/secret-type=cluster`

### Secret Not Appearing
- Check the job logs in the `secrets` namespace
- Verify RBAC permissions are correct
- Manually trigger a sync of the `home-cluster-access` application

### Kubeconfig Not Working
- The job validates the kubeconfig before creating the secret
- Check if the ArgoCD cluster secret is valid
- You may need to regenerate the cluster secret in ArgoCD

## Manual Refresh

To regenerate the kubeconfig, simply trigger a sync of the `home-cluster-access` application in ArgoCD. The PreSync hook will run again and update the secret/configmap.

## Token Expiration

The kubeconfig uses a service account token that is automatically generated by the job. The token expiration depends on how it's created:

- **Long-lived token (preferred)**: If `kubectl create token` is available (Kubernetes 1.22+), the token is created with a **1 year expiration** (8760 hours) and is **not bound to the pod**, so it remains valid even after the job pod is deleted
- **Fallback token**: If TokenRequest fails, it falls back to the projected service account token which expires after **1 hour** (default Kubernetes behavior)

**Important**: The token is created **without pod binding** (`--bound-object-kind` is not used), which means:
- ✅ The token remains valid after the job pod completes and is deleted
- ✅ Multiple kubectl connections can use the same kubeconfig simultaneously
- ✅ The token is valid for the full 1-year duration (or until manually rotated)

**Note**: The job runs automatically whenever ArgoCD syncs the `home-cluster-access` application, so the kubeconfig is regularly refreshed. However, if you don't sync for a long time, the token may expire.

**To check token expiration** (if you have kubectl access):
```bash
# Decode and check the JWT token expiration
kubectl -n secrets get secret cluster-kubeconfig -o jsonpath='{.data.kubeconfig}' | \
  base64 -d | grep -A 1 "token:" | tail -1 | \
  cut -d. -f2 | base64 -d 2>/dev/null | python3 -m json.tool | grep exp
```

The `exp` field shows the Unix timestamp when the token expires.

