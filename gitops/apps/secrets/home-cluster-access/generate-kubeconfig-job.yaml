apiVersion: batch/v1
kind: Job
metadata:
  name: generate-argocd-kubeconfig
  namespace: secrets
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  backoffLimit: 3
  template:
    spec:
      serviceAccountName: kubeconfig-generator
      restartPolicy: OnFailure
      containers:
        - name: generator
          image: bitnami/kubectl:latest
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -c
            - |
              set -euo pipefail
              echo "Starting kubeconfig generation..."
              
              # find the first argocd cluster secret
              SECRET_NAME=$(kubectl -n argocd get secret -l argocd.argoproj.io/secret-type=cluster -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
              if [ -z "$SECRET_NAME" ]; then
                echo "ERROR: no argocd cluster secret found"
                exit 1
              fi
              echo "Found ArgoCD cluster secret: $SECRET_NAME"
              
              # try common keys for kubeconfig
              KUBE_B64=$(kubectl -n argocd get secret "$SECRET_NAME" -o jsonpath='{.data.kubeconfig}' 2>/dev/null || true)
              if [ -z "$KUBE_B64" ]; then
                KUBE_B64=$(kubectl -n argocd get secret "$SECRET_NAME" -o jsonpath='{.data.config}' 2>/dev/null || true)
              fi
              if [ -z "$KUBE_B64" ]; then
                echo "ERROR: no kubeconfig found in secret $SECRET_NAME"
                echo "Available keys in secret:"
                kubectl -n argocd get secret "$SECRET_NAME" -o jsonpath='{.data}' | grep -o '"[^"]*":' || true
                exit 1
              fi
              
              # decode and write a temporary kubeconfig
              echo "$KUBE_B64" | base64 -d > /tmp/kubeconfig
              
              # Verify kubeconfig is valid
              if ! kubectl --kubeconfig=/tmp/kubeconfig cluster-info >/dev/null 2>&1; then
                echo "WARNING: Generated kubeconfig may not be valid, but continuing..."
              fi
              
              # Create or update secret in 'argocd' namespace
              echo "Creating/updating secret cluster-kubeconfig in argocd namespace..."
              kubectl -n argocd delete secret cluster-kubeconfig 2>/dev/null || true
              kubectl -n argocd create secret generic cluster-kubeconfig \
                --from-file=kubeconfig=/tmp/kubeconfig
              kubectl -n argocd label secret cluster-kubeconfig \
                app.kubernetes.io/name=cluster-kubeconfig \
                app.kubernetes.io/managed-by=argocd \
                purpose=cluster-access \
                --overwrite
              echo "✅ Secret cluster-kubeconfig created/updated in argocd namespace"
              
              # Also create a ConfigMap version for easier viewing in UI (kubeconfig as base64)
              echo "Creating/updating configmap cluster-kubeconfig-view in argocd namespace..."
              kubectl -n argocd delete configmap cluster-kubeconfig-view 2>/dev/null || true
              kubectl -n argocd create configmap cluster-kubeconfig-view \
                --from-literal=kubeconfig.b64="$KUBE_B64" \
                --from-literal=instructions="Decode kubeconfig.b64 with: echo '<base64>' | base64 -d > kubeconfig"
              kubectl -n argocd label configmap cluster-kubeconfig-view \
                app.kubernetes.io/name=cluster-kubeconfig \
                app.kubernetes.io/managed-by=argocd \
                purpose=cluster-access \
                --overwrite
              echo "✅ ConfigMap cluster-kubeconfig-view created/updated in argocd namespace"
              echo ""
              echo "Access your kubeconfig via ArgoCD UI:"
              echo "  1. Go to Settings > Secrets or Resources"
              echo "  2. Filter by label: purpose=cluster-access"
              echo "  3. View secret 'cluster-kubeconfig' or configmap 'cluster-kubeconfig-view'"
      securityContext:
        runAsUser: 0
        runAsGroup: 0
